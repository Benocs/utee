#!/bin/bash

##################################
# run utee
##################################

#
# start utee using strace
#
#strace_="strace -- "
strace_=

#
# start utee using valgrind
#
#valgrind_="valgrind --track-origins=yes --leak-check=full --show-leak-kinds=all -v"
#valgrind_="valgrind --track-origins=yes --leak-check=full --show-leak-kinds=all"
valgrind_=

#
# generate core dump on crash
#
ulimit_="ulimit -c unlimited"

listen_address="0.0.0.0"
listen_port=2056

#mode="d"
#mode_extra=""
mode="r"
#mode_extra="-L"
#mode_extra="-H"
#mode_extra=""

lb_every="1000000"
threshold="0.1"

#number_of_threads=2
number_of_threads=32
targets="100.70.128.153:2100 \
100.70.128.153:2101 \
100.70.128.153:2102 \
100.70.128.153:2103 \
100.70.128.153:2104 \
100.70.128.153:2105 \
100.70.128.153:2106 \
100.70.128.153:2107 \
100.70.128.153:2108 \
100.70.128.153:2109 \
100.70.128.153:2110 \
100.70.128.153:2111 \
100.70.128.153:2112 \
100.70.128.153:2113 \
100.70.128.153:2114 \
100.70.128.153:2115 \
100.70.128.153:2116 \
100.70.128.153:2117 \
100.70.128.153:2118 \
100.70.128.153:2119 \
100.70.128.153:2120 \
100.70.128.153:2121 \
100.70.128.153:2122 \
100.70.128.153:2123 \
100.70.128.153:2124 \
100.70.128.153:2125 \
100.70.128.153:2126 \
100.70.128.153:2127 \
100.70.128.153:2128 \
100.70.128.153:2129 \
100.70.128.153:2130 \
100.70.128.153:2131"

#number_of_threads=15
#
#targets="10.0.1.2:2100 \
#10.0.1.2:2101 \
#10.0.1.2:2102 \
#10.0.1.2:2103 \
#10.0.1.2:2104 \
#10.0.1.2:2105 \
#10.0.1.2:2106 \
#10.0.1.2:2107 \
#10.0.1.2:2108 \
#10.0.1.2:2109 \
#10.0.1.2:2110 \
#10.0.1.2:2111 \
#10.0.1.2:2112 \
#10.0.1.2:2113 \
#10.0.1.2:2114"

# echo 268435456 > /proc/sys/net/core/rmem_max
${ulimit_}
set -x
#${strace_} valgrind --track-origins=yes ./utee -l ${listen_address}:${listen_port} \
${strace_} ${valgrind_} ./utee -l ${listen_address}:${listen_port} \
    -m ${mode} ${mode_extra} -n ${number_of_threads} \
    -i ${lb_every} -t ${threshold} \
    ${targets}

## rr:

##ts     listener        in_bytecnt      out_bytecnt     in_packets      out_packets
#toggling stats output: 1
#1457453828      0       60711574        60711574        116772  116772
#1457453828      1       61244156        61244156        117366  117366
#1457453828      2       60839488        60839488        116835  116835
#1457453828      3       61118190        61118190        118493  118493
#1457453828      4       60552698        60552698        116571  116571
#1457453828      5       60574418        60574418        116714  116714
#1457453828      6       61469814        61469814        118330  118330
#1457453828      7       61025602        61025602        117112  117112
#1457453828      8       60869016        60869016        117294  117294
#1457453828      9       60077932        60077932        115460  115460
#1457453828      10      60290546        60290546        116308  116308
#1457453828      11      61317490        61317490        117886  117886
#1457453828      12      60406934        60406934        115787  115787
#1457453828      13      60652096        60652096        116972  116972
#1457453828      14      60398228        60398228        116786  116786
#1457453828      15      59382924        59382924        114253  114253
#1457453828      16      60383514        60383514        116441  116441
#1457453828      17      61635954        61635954        118632  118632
#1457453828      18      60615346        60615346        115200  115200
#1457453828      19      60246442        60246442        116483  116483
#1457453828      20      60068776        60068776        115492  115492
#1457453828      21      60137314        60137314        115415  115415
#1457453828      22      60269878        60269878        115242  115242
#1457453828      23      59915886        59915886        115139  115139
#1457453828      24      60442532        60442532        116394  116394
#1457453828      25      60744156        60744156        116549  116549
#1457453828      26      60439162        60439162        116292  116292
#1457453828      27      60462700        60462700        115872  115872
#1457453828      28      59863472        59863472        113441  113441
#1457453828      29      59545344        59545344        114076  114076
#1457453828      30      60124218        60124218        115884  115884
#1457453828      31      60550924        60550924        115143  115143
#toggling stats output: 0


